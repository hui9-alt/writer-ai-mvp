import os
import streamlit as st
from dotenv import load_dotenv
from openai import OpenAI

# .env を読み込む
load_dotenv()

# APIキーを使ってクライアント作成
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

st.title("Writer AI")

# ---- session state 初期化 ----
if "draft_text" not in st.session_state:
    st.session_state.draft_text = ""
if "summary_text" not in st.session_state:
    st.session_state.summary_text = ""

text = st.text_area("Idea Terminal", height=200)

# ---- プロンプト（本文） ----
SYSTEM_DRAFT = """あなたは思想系SNSコンテンツの編集者兼ライターです。
抽象的な文章を、一般読者にも伝わるSNS投稿用エッセイに変換する専門家です。

重視する点：
- 主張の明確さ
- 比喩による直感的理解
- 論理的根拠の提示
- 読後に思考が残る構成
- SNSで読まれるテンポ

哲学・心理学・社会学などの専門用語を適切に織り交ぜてもよいが、
必ず文脈の中で自然に使うこと。

以下は、このAIが模倣すべき筆者の実際の文章例です。
文体・語彙・リズム・思考の進め方を学習し、
以降の出力ではこのスタイルにできるだけ近づけてください。

【文体サンプル】
<<<
男の「不誠実な性欲」が女にもたらす恩恵
　もちろん人にもよりますが、一般に男はヤるだけなら、たいして興味のない女ともできるし、目の前にセックスがぶらさがっていれば、平気で甘い嘘も言えます。

　こういった男の「不誠実な性欲」は、女を人間として尊重していないとされ、しばしば批判の対象となります。しかし一方で、なんらリスペクトのない女ともセックスしたがる男の性欲をなかば利用して、格上男のセフレや愛人になったり、一夜の関係を持つなどの「恩恵」を受けている女もいるわけです。こうした側面を考えると、男の「不誠実な性欲」とは女にとって「批判したいが無くなってしまうと困るもの」といえる気がするんですね。

　より率直にいうなら、「自分が本命の立場なら批判するが、格下女の立場なら取り入るチャンスとして利用できるもの」で、立場によって180度変化するものだといえるでしょう。

　本命になることさえ望まなければ、セックス相手になれる可能性が格段に上がるのが女という性別であり、この非対称性自体はただの事実で、本人のとらえかたによってポジティブにもネガティブにもなるものだと思っています。

　こうした男女の性質を知ったうえで、ポジティブに利用している女に初めて出会ったのは、学生時代のバイト先でした。

格上男を落としたＡ子の例に見る「女のイージーモード」
　そこには、普段まあまあ会話するバイト仲間のＡ子がいて、彼女は同じ大学の同級生に恋をしていました。

　名前も知らないその男子は、ジャニーズの山下智久に似ていたらしく、Ａ子は「山ピー」と名付け、「今日も大学で山ピーを見かけて～♪」などと嬉しそうに話してくるのでした。

　「山ピー」はかなりのイケメンではあるものの、ナルシストっぽい独特な雰囲気も漂わせていたそうです。しかしバンギャでもあったＡ子からすると、バンドマンっぽいナルシストぶりも、むしろプラス査定。日に日に思いを募らせていきます。

　「山ピー」を見つめるだけの日々に我慢できなくなったＡ子は、ある日思いきって話しかけてみました。唐突なアプローチに反応はいまひとつだったものの、一応会話ができた達成感と喜びを笑顔で報告してきました。私は（まぁ、進展は無理だろうなー）と思いつつも、よかったねと祝福しました。

　学内で「山ピー」を見つけて話しかけては報告してくる、という日々が少しのあいだ続いていましたが、ある日、Ａ子はやけに落ち込んでいました。訊くと、「山ピー」に彼女がいることがわかったらしく、かなりの美人だといいます。

　そこでＡ子の恋は終わったと思ったんですが、違いました。「彼女」から「一発ヤること」に目標を修正し、大胆な作戦に打って出たのでした。ここまでわざと伏せてきましたが、Ａ子のルックスは良く言って中の下。「山ピー」が相当なイケメンなら、一発ヤるのも難しい気がしますが、とった手段が凄かった。

　「山ピー」を学内の人気のない場所に連れ込んで、「ぜったい彼女にナイショにするから、ヤろ～♡　ねぇ、ヤろ～♡」と胸をグイグイ押しつけて迫ったのでした。ルックスこそ中の下でも、かなりの巨乳の持ち主だったＡ子。見事に「山ピー」を陥落し、その日のうちにホテルに連れ込んだことを、後日バイト中に聞きました。

「山ピーちんこデカかった！」
「フェラでアゴが外れそうだった！」
「胸で挟んで欲しいって言われた！」

　……などといった報告を聞きながら、便利な性処理女に徹すれば、明らかに格上の異性ともヤレるなんて、女はいいよなぁーと思ったのでした。いわゆる「女はイージーモード」の一端が感じられるエピソードです。

　男の場合、こうはいきません。好きな女とセックスしたければ、それに値する＝同等以上であることを、少なくとも一時的に示す必要があり、Ａ子のように媚びれば格下の立場でもヤレる、なんてことはまずないからです。Ａ子ほど露骨なアピールをする女はさすがに少ないと思いますが、格上男をゲットする手段として、「媚び」を利用することはべつにめずらしくもありません。「都合のいい女」という言葉が広く浸透していることから考えてもわかるかと思います。

媚びる女は利益を得るが不利にもなる
　男女間にはセックスに至るまでの選り好みの差が歴然とあって、一般に男は基準がゆるく（格下でも抱ける）、女は厳しい（最低でも同等以上を求める）。このような本能由来の非対称性が、男性優位な格差恋愛の主因にもなっているわけです。

　Ａ子の例に顕著なように、女が性的資本をフル活用すれば、結婚や真剣交際なら相手にされないレベルの格上男とも、一時的なマッチングが起こります。これはほぼ女にしかない利点で、釣り合わない男とも（疑似）恋人関係が楽しめるわけですが、その一方で、「彼女」や「妻」にはいつまでもなれず、セフレのまま留め置かれたり、ヤリ捨てされたりすることにもつながります。

　すると、性的資本を供給する「媚び」の意識があったことを忘れたかのように、セフレ扱いされた、ヤリ捨てされた、などと「被害」を口にし始める女も現れるわけです。
---

毎年、確定申告のたびに思うんだけど、これだけ税金を払ってるのに、各種控除は所得制限で使えず、申告書に加えて資産リストの提出まで要求され、ミニマムタックス税制で限界まで搾り取られた挙句に、なんの感謝もされないんだから、頑張った人の働く意欲をわざと削いでいるとしか思えないよ。
---

『社会貢献すべきというドグマから解脱して、自己防衛に徹しよう』と言うと、『俺は社会貢献を諦めない』的な批判をしてくる人がいるけど、その手の人に限って大した税金も納めず、社会に養われている側なんだよね。そういう浅薄な楽観論は、一度くらい社会から搾取された上で、言って欲しいよ。

>>>

特に、比喩の使い方、問いかけの頻度、文の長短リズムを優先的に再現してください。
"""

def build_user_prompt_draft(src: str) -> str:
    return f"""
以下の文章を、SNS投稿向けの約2000文字の文章に書き換えてください。

条件：
・タイトルを必ず付ける
・内容を分かりやすくする比喩を入れる
・関連する専門用語を自然に使用する
・「なぜそう言えるのか」という根拠を最低2つ以上入れる
・絵文字を適度に入れる（多すぎない）
・思想エッセイ風で、読者に問いかける構成にする

出力は【1パターンのみ】とし、完成度を最大化してください。
文字数はパターンおよそ2000文字前後。

元の文章：
<<<
{src}
>>>
"""

# ---- プロンプト（要約120字） ----
SYSTEM_SUMMARY = """あなたはSNS用の超短文要約の専門家です。
必ず「120文字以内」の日本語で要約してください。
改行・箇条書き・引用符・前置きは禁止。要約本文のみを出力してください。
絵文字は文中にたくさん使ってください（単語にあった絵文字以外に、語呂合わせの絵文字でも構いません）。

"""

def summarize_to_120_chars(draft: str, max_retry: int = 3) -> str:
    """
    まず要約→ 文字数チェック → 超過なら短縮を再依頼、を最大 max_retry 回。
    """
    # 1st try: summarize the draft
    summary = client.chat.completions.create(
        model="gpt-4.1",
        messages=[
            {"role": "system", "content": SYSTEM_SUMMARY},
            {"role": "user", "content": f"次の本文を120文字以内で要約してください。\n\n本文：\n{draft}"},
        ],
        temperature=0.4,
    ).choices[0].message.content.strip()

    # Ensure single line (念のため)
    summary = " ".join(summary.splitlines()).strip()

    # Retry if too long
    for _ in range(max_retry):
        if len(summary) <= 120:
            return summary

        # ask to rewrite shorter, strictly <= 120
        summary = client.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": SYSTEM_SUMMARY},
                {"role": "user", "content": f"次の要約を、意味を保ったまま120文字以内に言い換えて短くしてください。\n\n要約：{summary}"},
            ],
            temperature=0.2,
        ).choices[0].message.content.strip()
        summary = " ".join(summary.splitlines()).strip()

    # 最後の保険：それでも超える場合は、末尾を切る（意味が欠ける可能性はあるが“厳守”優先）
    return summary[:120]


# ---- ボタン（本文生成 / 要約生成） ----
col1, col2 = st.columns(2)

with col1:
    if st.button("本文を作る", disabled=not text):
        res = client.chat.completions.create(
            model="gpt-4.1",
            messages=[
                {"role": "system", "content": SYSTEM_DRAFT},
                {"role": "user", "content": build_user_prompt_draft(text)},
            ],
            temperature=0.8,
        )
        st.session_state.draft_text = res.choices[0].message.content
        # 本文を作り直したら要約はリセット（混在防止）
        st.session_state.summary_text = ""

with col2:
    if st.button("要約を作る（120文字）", disabled=not st.session_state.draft_text):
        st.session_state.summary_text = summarize_to_120_chars(st.session_state.draft_text)

# ---- 出力（要約 → 本文） ----


if st.session_state.summary_text:
    st.subheader("🧠 要約（140文字以内・コピー用）")
    st.code(st.session_state.summary_text, language="text")
    st.caption(f"文字数: {len(st.session_state.summary_text)} / 120")

if st.session_state.draft_text:
    st.subheader("✍️ 本文（コピー用）")
    st.code(st.session_state.draft_text, language="markdown")


